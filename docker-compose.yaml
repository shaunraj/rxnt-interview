version: '3.8'

services:
  marketing-site:
    build:
      context: .
      dockerfile: Dockerfile.site
      image: "${ACR_REGISTRY_URL}/internal/marketing-site:latest"
    ports:
      - "8881:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - REDIS_CONNECTION_STRING=redis:6379
      - MarketingApi__BaseUrl=http://marketing-api:8080
    depends_on:
      redis:
        condition: service_healthy
      marketing-api:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://marketing-api:8080/health"]
      interval: 3s
      timeout: 1s
      retries: 5
    
  marketing-api:
    build:
      context: .
      dockerfile: Dockerfile.api
      image: "${ACR_REGISTRY_URL}/internal/marketing-api:latest"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - DB_CONNECTION_STRING=Server=database;Database=master;User Id=sa;Password=Password123; TrustServerCertificate=True;
    depends_on:
      database:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://marketing-api:8080/health"]
      interval: 3s
      timeout: 1s
      retries: 5

  redis:
    image: redis:7.0
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 3s
      timeout: 10s
      retries: 5
    profiles: ["development"]

  database:
    image: mcr.microsoft.com/mssql/server:2022-latest
    environment:
      SA_PASSWORD: "Password123"
      ACCEPT_EULA: "Y"
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -C -S localhost -U sa -P $$SA_PASSWORD -d master -Q 'SELECT 1' || exit 1"]
      interval: 3s
      retries: 15
      start_period: 10s
      timeout: 1s
    profiles: ["development"]